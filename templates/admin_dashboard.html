{% extends "base.html" %}
{% block title %}Dashboard Admin - NovaStore{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}

{% block content %}
<div class="container" style="padding: 40px 20px;">
    
    <!-- Header -->
    <div class="admin-header">
        <div>
            <h1 class="admin-title">Tableau de Bord</h1>
            <p style="color: #64748b;">Vue d'ensemble de votre boutique</p>
        </div>
        <div style="display: flex; gap: 20px; align-items: center;">
            <!-- Filtre P√©riode -->
            <form action="{{ url_for('main.admin_dashboard') }}" method="GET">
                <select name="period" onchange="this.form.submit()" style="padding: 10px 15px; border-radius: 8px; border: 1px solid #cbd5e1; cursor: pointer; font-weight: 500;">
                    <option value="all" {% if current_period == 'all' %}selected{% endif %}>Tout l'historique</option>
                    <option value="today" {% if current_period == 'today' %}selected{% endif %}>Aujourd'hui</option>
                    <option value="week" {% if current_period == 'week' %}selected{% endif %}>7 derniers jours</option>
                    <option value="month" {% if current_period == 'month' %}selected{% endif %}>Ce mois-ci</option>
                </select>
            </form>
            <a href="{{ url_for('main.admin_logout') }}" style="color: #ef4444; text-decoration: none; font-weight: 600; padding: 10px 20px; background: #fee2e2; border-radius: 8px;">D√©connexion</a>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-icon" style="background: #eff6ff; color: #2563eb;">üí∞</div>
            <div class="kpi-info">
                <h3>Chiffre d'Affaires</h3>
                <span class="kpi-value">{{ kpi_revenue }} DH</span>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon" style="background: #f0fdf4; color: #166534;">üì¶</div>
            <div class="kpi-info">
                <h3>Commandes</h3>
                <span class="kpi-value">{{ kpi_orders }}</span>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon" style="background: #fff7ed; color: #ea580c;">‚ö†Ô∏è</div>
            <div class="kpi-info">
                <h3>Stock Faible</h3>
                <span class="kpi-value">{{ kpi_low_stock }}</span>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon" style="background: #fef2f2; color: #ef4444;">üîî</div>
            <div class="kpi-info">
                <h3>Alertes Client</h3>
                <span class="kpi-value">{{ alertes|length }}</span>
            </div>
        </div>
    </div>

    <!-- Graphiques -->
    <div class="charts-grid">
        <div class="chart-card">
            <h3 style="margin-bottom: 20px; color: #1e293b;">üìä Ventes par Produit</h3>
            <canvas id="salesChart" style="max-height: 300px;"></canvas>
        </div>
        <div class="chart-card">
            <h3 style="margin-bottom: 20px; color: #1e293b;">üí∞ Chiffre d'Affaires (DH)</h3>
            <canvas id="revenueChart" style="max-height: 300px;"></canvas>
        </div>
    </div>

    <!-- Tableau des produits -->
    <h3 style="margin-bottom: 20px; color: #1e293b;">üì¶ Gestion des Stocks</h3>
    <div class="table-container">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Produit</th>
                    <th style="text-align: center;">√âtat du Stock</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for p in produits %}
                <tr>
                    <td>
                        <div class="product-cell">
                            <img src="{{ p.image }}" class="product-thumb">
                            <strong>{{ p.nom }}</strong>
                        </div>
                    </td>
                    <td style="text-align: center;">
                        {% if p.stock == 0 %}
                            <span class="stock-badge stock-out">Rupture</span>
                        {% elif p.stock < 5 %}
                            <span class="stock-badge stock-low">{{ p.stock }} restants</span>
                        {% else %}
                            <span class="stock-badge stock-ok">{{ p.stock }} en stock</span>
                        {% endif %}
                    </td>
                    <td>
                        <form action="{{ url_for('main.admin_restock') }}" method="POST" class="restock-form">
                            <input type="hidden" name="product_id" value="{{ p.id }}">
                            <input type="number" name="quantity" value="10" min="1" class="input-qty">
                            <button type="submit" class="btn-add-stock">+ Ajouter</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Liste des alertes en attente -->
    <div style="margin-top: 40px;">
        <h3>üîî Alertes en attente ({{ alertes|length }})</h3>
        {% if alertes %}
            <ul style="background: white; padding: 20px; border-radius: 12px; list-style: none;">
                {% for a in alertes %}
                    <li style="padding: 10px; border-bottom: 1px solid #f1f5f9;">
                        Client <strong>{{ a.email }}</strong> attend le produit ID <strong>{{ a.product_id }}</strong>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p style="color: #64748b;">Aucune alerte en attente.</p>
        {% endif %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('salesChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: {{ chart_labels|tojson }},
            datasets: [{
                label: 'Quantit√© Vendue',
                data: {{ chart_data|tojson }},
                backgroundColor: '#FF6A3D',
                borderRadius: 6,
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
    });

    const ctxRevenue = document.getElementById('revenueChart').getContext('2d');
    new Chart(ctxRevenue, {
        type: 'line',
        data: {
            labels: {{ revenue_labels|tojson }},
            datasets: [{
                label: "Chiffre d'Affaires",
                data: {{ revenue_data|tojson }},
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
        }
    });
</script>
{% endblock %}
